<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Coin Market Cap</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="../css/style.min.css">
  </head>
  <body>
    <h1>Coin Market Cap</h1>
    <div class="search-bar">
        <input
          class="search-bar-input"
          placeholder="Search for cryptocurrency..."
          type="text"
          autofocus>
    </div>
    <div class="container">
      <!-- Filled by JS. -->
      <div class="placeholder">Fetching...</div>
    </div>
  </body>

  <script>
    // Constants
    const DISPLAY_LIMIT = 20;
    const FETCH_INTV = 20000;

    // Require electron remote
    const remote = require('electron').remote;

    // Grab HTML elements
    const title = document.getElementsByTagName ('h1')[0];
    const container = document.getElementsByClassName ('container')[0];
    const search_bar = document.querySelector ('.search-bar-input');

    // Require new and shiny API.
    const {Connector, Provider} = require ('../js/coinmarketcap.api.js');
    const {HtmlBuilder} = require ('../js/htmlbuilder.js');

    // Create instances
    const connector = new Connector ();
    const provider = new Provider (connector);
    const builder = new HtmlBuilder ();

    const get_remote_state = () => Object.assign({}, remote.getGlobal('cmcstate'));

    const update_dom = async () => {

      // Get cached data
      const data = await provider.__retrieve_cached ({
        display_limit: DISPLAY_LIMIT,
        currency: get_remote_state().currency,
      });

      // Build html representation
      container.innerHTML = builder.build (data, {
        trunc_info_block: true,
        currency: get_remote_state().currency,
      });
    };

    const fetch_initialize = async () => {

      // Fill cache
      await provider.fill_cache ({
        currency: get_remote_state().currency,
      });

      // Update DOM
      update_dom ();
    };

    const update_dom_dynamic = async () => {

      // Test if search-bar is empty
      if (search_bar.value.length === 0) {

        // Update DOM from cache
        return update_dom ();
      }

      // Initialize variables
      let match = false;
      let alt_matches = [];

      // Grab cached data
      const data = await provider.__retrieve_cached ({
        currency: get_remote_state().currency,
      });

      // Iterate over cached coins
      for (const coin of data) {

        // Get lowercase search term
        let value = search_bar.value.toLowerCase ();

        // Test if search term matches any coins
        if (
          coin.symbol.toLowerCase () === value
          || coin.id.toLowerCase () === value
          || coin.name.toLowerCase () === value
        ) {

          // We found a match
          match = true;

          // Update DOM with cached data
          container.innerHTML = builder.build ([coin], {
            currency: get_remote_state().currency,
          });
        }

        // Test if alternative cryptocurrency matches
        else if (true
          && coin.name.toLowerCase ().includes (value)
          && alt_matches.length < DISPLAY_LIMIT
        ) alt_matches.push (coin); // Add cryptocurrency to match list
      }

      // Test if alternative matches were found
      if (!match && alt_matches.length > 0) {

        // Update DOM with matched data
        container.innerHTML = builder.build (alt_matches, {
          currency: get_remote_state().currency,
        });
      } else if (!match) {
        container.innerHTML = `<div class="placeholder">Cryptocurrency not found :(</div>`;
      }
    };

    // Initialize cache and update DOM
    fetch_initialize ();

    // Set update interval
    setInterval (() => {

      // Update cache
      provider.fill_cache ({
        currency: get_remote_state().currency,
      }).then (_ => {

        // Update DOM dynamically
        update_dom_dynamic ();
      }).catch (err => console.log (err));
    }, FETCH_INTV);

    let old_remote_state = get_remote_state();
    setInterval (() => {
      const new_remote_state = get_remote_state();
      if (old_remote_state.currency !== new_remote_state.currency) {
        provider.fill_cache ({
          currency: new_remote_state.currency,
        }).then (_ => update_dom_dynamic());
      }
      old_remote_state = new_remote_state;
    }, 500);

    // Handle search functionality
    search_bar.oninput = update_dom_dynamic;
  </script>
</html>
